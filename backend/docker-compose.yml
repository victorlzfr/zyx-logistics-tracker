# docker-compose.yml - ZYX Logistics Tracker
# PostgreSQL 15 para desenvolvimento local
# Autor: Victor Luiz de França
# Data: 03/12/2025
# Para: DHL Teste Técnico - Analista de Sistemas Operacionais JR

# DEFINIÇÃO DOS SERVIÇOS (CONTAINERS) ======================================
services:
  # SERVIÇO: PostgreSQL Database
  postgres: # Configurações do PostgreSQL
    image: postgres:15 # Imagem oficial do PostgreSQL versão 15
    container_name: zyx-postgres # Nome personalizado do container (facilita identificação)

    # VARIÁVEIS DE AMBIENTE DO POSTGRESQL ==================================
    # Definidas aqui, são injetadas no container ao iniciar
    environment:
      POSTGRES_USER: admin # Usuário administrador do banco
      POSTGRES_PASSWORD: admin123 # Senha do usuário administrador
      POSTGRES_DB: zyx_logistics # Nome do banco de dados que será criado automaticamente

    # MAPEAMENTO DE PORTAS ================================================
    ports:
      # Sintaxe: "HOST:CONTAINER"
      # Porta 5433 no host (WSL Ubuntu) para não conflitar com PostgreSQL local na 5432
      - "5433:5432" # Acesso externo via porta 5433 → PostgreSQL interno na 5432

    # VOLUMES (PERSISTÊNCIA DE DADOS) =====================================
    volumes:
      # Volume nomeado para persistência: dados sobrevivem a reinicializações
      # postgres_data (no host) → /var/lib/postgresql/data (no container)
      - postgres_data:/var/lib/postgresql/data

      # Volume para scripts de inicialização (opcional):
      # Scripts SQL na pasta ./init-scripts serão executados ao iniciar container
      # - ./init-scripts:/docker-entrypoint-initdb.d

    # HEALTHCHECK (VERIFICAÇÃO DE SAÚDE) ==================================
    # Docker periodicamente verifica se o serviço está saudável
    healthcheck:
      # Comando de teste: pg_isready verifica se PostgreSQL aceita conexões
      test: ["CMD-SHELL", "pg_isready -U admin -d zyx_logistics"]
      interval: 10s # Executa a cada 10 segundos
      timeout: 5s   # Tempo máximo de espera para resposta
      retries: 5    # Número de tentativas antes de marcar como não saudável
      start_period: 30s # Tempo inicial antes de começar os health checks

    # POLÍTICA DE REINÍCIO ================================================
    restart: unless-stopped
    # Opções: no (nunca), always (sempre), on-failure (apenas em falha), unless-stopped

    # REDES ===============================================================
    networks:
      - zyx-network # Conecta o container à rede personalizada

# DEFINIÇÃO DE VOLUMES PERSISTENTES ========================================
# Volumes são mecanismos de armazenamento de dados que persistem além do ciclo de vida do container
volumes:
  postgres_data: # Volume para armazenar dados do PostgreSQL
    name: zyx_postgres_data # Nome personalizado do volume (facilita gerenciamento)
    # O Docker gerencia automaticamente a localização física no disco
    # Dados são preservados mesmo se o container for removido

# DEFINIÇÃO DE REDES =======================================================
# Redes isolam a comunicação entre containers e host
networks:
  zyx-network: # Rede personalizada para os serviços do projeto
    name: zyx_network # Nome personalizado da rede
    # Vantagens: isolamento, comunicação controlada, DNS automático entre containers
    driver: bridge # Driver padrão (bridge = comunicação via ponte)
    # Alternativas: host (usa rede do host), overlay (para múltiplos hosts Docker)
