{"version":3,"file":"shipmentController.js","sourceRoot":"","sources":["../../src/controllers/shipmentController.ts"],"names":[],"mappings":"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","sourcesContent":["import { Request, Response } from 'express';\nimport { query } from '../db/connection';\nimport { \n  Shipment, \n  ShipmentCreateDTO, \n  ShipmentUpdateDTO, \n  ApiResponse,\n  ShipmentStatus \n} from '../types/shipment.types';\n\nexport class ShipmentController {\n  // GET /api/shipments - Listar todas as cargas\n  static async getAllShipments(\n    req: Request, \n    res: Response<ApiResponse<Shipment[]>>\n  ): Promise<void> {\n    try {\n      const result = await query<Shipment>(\n        'SELECT * FROM shipments ORDER BY created_at DESC'\n      );\n      \n      const response: ApiResponse<Shipment[]> = {\n        success: true,\n        count: result.rowCount,\n        data: result.rows\n      };\n      \n      res.status(200).json(response);\n    } catch (error: any) {\n      console.error('Error fetching shipments:', error);\n      \n      const response: ApiResponse = {\n        success: false,\n        message: 'Erro ao buscar cargas',\n        error: process.env.NODE_ENV === 'development' ? error.message : undefined\n      };\n      \n      res.status(500).json(response);\n    }\n  }\n\n  // GET /api/shipments/:id - Buscar carga por ID\n  static async getShipmentById(\n    req: Request<{ id: string }>, \n    res: Response<ApiResponse<Shipment>>\n  ): Promise<void> {\n    try {\n      const { id } = req.params;\n      const result = await query<Shipment>(\n        'SELECT * FROM shipments WHERE id = $1', \n        [id]\n      );\n\n      if (result.rows.length === 0) {\n        const response: ApiResponse = {\n          success: false,\n          message: 'Carga não encontrada'\n        };\n        res.status(404).json(response);\n        return;\n      }\n\n      const response: ApiResponse<Shipment> = {\n        success: true,\n        data: result.rows[0]\n      };\n      \n      res.status(200).json(response);\n    } catch (error: any) {\n      console.error('Error fetching shipment:', error);\n      \n      const response: ApiResponse = {\n        success: false,\n        message: 'Erro ao buscar carga',\n        error: process.env.NODE_ENV === 'development' ? error.message : undefined\n      };\n      \n      res.status(500).json(response);\n    }\n  }\n\n  // GET /api/shipments/tracking/:trackingNumber - Buscar por número de rastreamento\n  static async getShipmentByTrackingNumber(\n    req: Request<{ trackingNumber: string }>, \n    res: Response<ApiResponse<Shipment>>\n  ): Promise<void> {\n    try {\n      const { trackingNumber } = req.params;\n      const result = await query<Shipment>(\n        'SELECT * FROM shipments WHERE tracking_number = $1', \n        [trackingNumber]\n      );\n\n      if (result.rows.length === 0) {\n        const response: ApiResponse = {\n          success: false,\n          message: 'Carga não encontrada'\n        };\n        res.status(404).json(response);\n        return;\n      }\n\n      const response: ApiResponse<Shipment> = {\n        success: true,\n        data: result.rows[0]\n      };\n      \n      res.status(200).json(response);\n    } catch (error: any) {\n      console.error('Error fetching shipment by tracking:', error);\n      \n      const response: ApiResponse = {\n        success: false,\n        message: 'Erro ao buscar carga',\n        error: process.env.NODE_ENV === 'development' ? error.message : undefined\n      };\n      \n      res.status(500).json(response);\n    }\n  }\n\n  // POST /api/shipments - Criar nova carga\n  static async createShipment(\n    req: Request<{}, {}, ShipmentCreateDTO>, \n    res: Response<ApiResponse<Shipment>>\n  ): Promise<void> {\n    try {\n      // Validação dos campos obrigatórios\n      const requiredFields: (keyof ShipmentCreateDTO)[] = [\n        'customer_name', \n        'origin', \n        'destination'\n      ];\n      \n      for (const field of requiredFields) {\n        if (!req.body[field]) {\n          const response: ApiResponse = {\n            success: false,\n            message: `Campo obrigatório faltando: ${field}`\n          };\n          res.status(400).json(response);\n          return;\n        }\n      }\n\n      // Gerar número de rastreamento automático se não fornecido\n      const trackingNumber = req.body.tracking_number || `ZYX${Date.now()}`;\n      \n      const shipmentData: ShipmentCreateDTO = {\n        ...req.body,\n        tracking_number: trackingNumber,\n        quantity: req.body.quantity || 1,\n        status: req.body.status || 'PENDING' as ShipmentStatus\n      };\n\n      const queryText = `\n        INSERT INTO shipments (\n          tracking_number, customer_name, origin, destination, \n          product_description, quantity, weight_kg, status, \n          estimated_arrival, notes\n        ) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10)\n        RETURNING *\n      `;\n\n      const params = [\n        shipmentData.tracking_number,\n        shipmentData.customer_name,\n        shipmentData.origin,\n        shipmentData.destination,\n        shipmentData.product_description || '',\n        shipmentData.quantity,\n        shipmentData.weight_kg || 0,\n        shipmentData.status,\n        shipmentData.estimated_arrival || null,\n        shipmentData.notes || ''\n      ];\n\n      const result = await query<Shipment>(queryText, params);\n\n      const response: ApiResponse<Shipment> = {\n        success: true,\n        message: 'Carga criada com sucesso',\n        data: result.rows[0]\n      };\n      \n      res.status(201).json(response);\n    } catch (error: any) {\n      console.error('Error creating shipment:', error);\n      \n      const response: ApiResponse = {\n        success: false,\n        message: 'Erro ao criar carga',\n        error: process.env.NODE_ENV === 'development' ? error.message : undefined\n      };\n      \n      res.status(500).json(response);\n    }\n  }\n\n  // PUT /api/shipments/:id/status - Atualizar status da carga\n  static async updateShipmentStatus(\n    req: Request<{ id: string }, {}, ShipmentUpdateDTO>, \n    res: Response<ApiResponse<Shipment>>\n  ): Promise<void> {\n    try {\n      const { id } = req.params;\n      const { status } = req.body;\n\n      const validStatuses: ShipmentStatus[] = [\n        'PENDING', \n        'IN_TRANSIT', \n        'DELIVERED', \n        'CANCELLED'\n      ];\n      \n      if (!validStatuses.includes(status)) {\n        const response: ApiResponse = {\n          success: false,\n          message: `Status inválido. Use: ${validStatuses.join(', ')}`\n        };\n        res.status(400).json(response);\n        return;\n      }\n\n      const queryText = `\n        UPDATE shipments\n        SET status = $1,\n            updated_at = CURRENT_TIMESTAMP,\n            actual_arrival = CASE\n              WHEN $1 = 'DELIVERED' THEN CURRENT_DATE\n              ELSE actual_arrival\n            END\n        WHERE id = $2\n        RETURNING *\n      `;\n\n      const result = await query<Shipment>(queryText, [status, id]);\n\n      if (result.rows.length === 0) {\n        const response: ApiResponse = {\n          success: false,\n          message: 'Carga não encontrada'\n        };\n        res.status(404).json(response);\n        return;\n      }\n\n      const response: ApiResponse<Shipment> = {\n        success: true,\n        message: 'Status atualizado com sucesso',\n        data: result.rows[0]\n      };\n      \n      res.status(200).json(response);\n    } catch (error: any) {\n      console.error('Error updating shipment status:', error);\n      \n      const response: ApiResponse = {\n        success: false,\n        message: 'Erro ao atualizar status',\n        error: process.env.NODE_ENV === 'development' ? error.message : undefined\n      };\n      \n      res.status(500).json(response);\n    }\n  }\n}\n\nexport default ShipmentController;\n"]}